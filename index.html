<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality Jobs - ML/DS Positions in Germany</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #1a1a1a;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .job-count {
            text-align: center;
            margin-bottom: 20px;
            color: #888;
        }
        .job-list {
            list-style: none;
        }
        .job-item {
            background: #fff;
            padding: 15px 20px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        .job-item:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .job-item.has-description:hover .job-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(0) translateY(-50%);
        }
        .job-tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateX(8px) translateY(-50%);
            margin-left: 8px;
            background: #333;
            color: #fff;
            padding: 14px 18px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: normal;
            line-height: 1.6;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
            width: 400px;
            max-height: 300px;
            overflow-y: auto;
        }
        .job-tooltip * {
            font-weight: normal !important;
        }
        .job-tooltip::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 6px solid #333;
        }
        .job-info {
            flex: 1;
        }
        .job-logo {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            object-fit: contain;
            background: #f5f5f5;
            padding: 4px;
            margin-right: 14px;
            flex-shrink: 0;
        }
        .job-title {
            color: #0066cc;
            text-decoration: none;
            font-weight: 500;
        }
        .job-title:hover {
            text-decoration: underline;
        }
        .job-company {
            color: #666;
            font-size: 0.9em;
            margin-top: 4px;
        }
        .job-company a {
            color: #0066cc;
            text-decoration: underline;
            text-decoration-style: dotted;
        }
        .job-company a:hover {
            color: #004499;
            text-decoration-style: solid;
        }
        .job-logo-link {
            display: block;
        }
        .job-logo-link:hover .job-logo {
            opacity: 0.8;
        }
        .job-location {
            color: #999;
            font-size: 0.85em;
        }
        .job-scraped {
            color: #aaa;
            font-size: 0.8em;
            margin-top: 2px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #cc0000;
        }
        .bin-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #666;
            color: white;
            padding: 12px 16px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 0.85em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .bin-link:hover {
            background: #555;
        }
        .bin-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9em;
        }
        .filter-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
        }
        .filter-btn {
            background: #666;
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: background 0.2s;
        }
        .filter-btn:hover {
            background: #555;
        }
        .filter-btn.active {
            background: #0066cc;
        }
        .filter-menu {
            position: absolute;
            top: 100%;
            left: 0;
            padding-top: 8px;
            background: transparent;
            min-width: 340px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }
        .filter-menu-inner {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            padding: 8px 0;
        }
        .filter-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .filter-menu label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 0.9em;
        }
        .filter-menu label:hover {
            background: #f5f5f5;
        }
        .filter-menu input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }
        .filter-count {
            margin-left: auto;
            color: #999;
            font-size: 0.85em;
        }
        .filter-divider {
            height: 1px;
            background: #eee;
            margin: 8px 0;
        }
        .filter-menu .select-all {
            color: #0066cc;
            font-weight: 500;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            max-height: 300px;
            overflow-y: auto;
        }
        .filter-grid label {
            min-width: 0;
        }
        .filter-grid label span:first-of-type {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .subscribe-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #0066cc;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.85em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            z-index: 100;
        }
        .subscribe-btn:hover {
            background: #0052a3;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.2s;
        }
        .modal-overlay.show .modal {
            transform: translateY(0);
        }
        .modal h2 {
            margin: 0 0 8px;
            color: #333;
        }
        .modal p {
            color: #666;
            margin: 0 0 20px;
            font-size: 0.9em;
        }
        .modal input[type="email"] {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 12px;
        }
        .modal input[type="email"]:focus {
            outline: none;
            border-color: #0066cc;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            transition: background 0.2s;
        }
        .modal-buttons .cancel-btn {
            background: #f0f0f0;
            border: none;
            color: #666;
        }
        .modal-buttons .cancel-btn:hover {
            background: #e0e0e0;
        }
        .modal-buttons .submit-btn {
            background: #0066cc;
            border: none;
            color: white;
        }
        .modal-buttons .submit-btn:hover {
            background: #0052a3;
        }
        .modal-buttons .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .modal-message {
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 12px;
            display: none;
        }
        .modal-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            display: block;
        }
        .modal-message.error {
            background: #ffebee;
            color: #c62828;
            display: block;
        }
    </style>
</head>
<body>
    <div class="filter-container" id="filter-container">
        <button class="filter-btn" id="filter-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
            Filter
        </button>
        <div class="filter-menu" id="filter-menu">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <div class="container">
        <h1>Quality Jobs</h1>
        <p class="subtitle">ML / Data Science Positions in Germany</p>
        <p class="job-count" id="job-count"></p>
        <ul class="job-list" id="job-list">
            <li class="loading">Loading jobs...</li>
        </ul>
    </div>

    <a href="bin.html" class="bin-link" id="bin-link" style="display: none;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
        <span class="bin-count" id="bin-count">0</span>
    </a>

    <button class="subscribe-btn" id="subscribe-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
        Subscribe
    </button>

    <div class="modal-overlay" id="subscribe-modal">
        <div class="modal">
            <h2>Get Job Alerts</h2>
            <p>Receive email notifications when new ML/DS jobs are posted.</p>
            <div class="modal-message" id="modal-message"></div>
            <form id="subscribe-form">
                <input type="email" id="subscribe-email" placeholder="your@email.com" required>
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" id="cancel-subscribe">Cancel</button>
                    <button type="submit" class="submit-btn" id="submit-subscribe">Subscribe</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allJobs = [];
        let selectedCompanies = new Set();
        let menuPinned = false;

        function formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        const companyDomains = {
            // Custom scrapers
            'Amazon': 'amazon.com',
            'SAP': 'sap.com',
            'Zalando': 'zalando.com',
            'Snapchat': 'snap.com',
            // Greenhouse companies
            'Bolt': 'bolt.eu',
            'N26': 'n26.com',
            'HelloFresh': 'hellofresh.com',
            'Databricks': 'databricks.com',
            'GitLab': 'gitlab.com',
            'Canonical': 'canonical.com',
            'Grafana Labs': 'grafana.com',
            'Grammarly': 'grammarly.com',
            'Vercel': 'vercel.com',
            'Cloudflare': 'cloudflare.com',
            'Discord': 'discord.com',
            'Stripe': 'stripe.com',
            'Coinbase': 'coinbase.com',
            'Dropbox': 'dropbox.com',
            'Reddit': 'reddit.com',
            'Airbnb': 'airbnb.com',
            'Figma': 'figma.com',
            'Datadog': 'datadoghq.com',
            'Elastic': 'elastic.co',
            'Collibra': 'collibra.com',
            // SmartRecruiters companies
            'Delivery Hero': 'deliveryhero.com',
            'AUTO1 Group': 'auto1-group.com',
        };

        function getCompanyLogo(company) {
            const domain = companyDomains[company] || dynamicDomains[company];
            if (domain) {
                return `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
            }
            return null;
        }

        // Domains extracted from jobs.json
        let dynamicDomains = {};

        function buildDomainMap(jobs) {
            jobs.forEach(job => {
                if (job.domain && !dynamicDomains[job.company]) {
                    dynamicDomains[job.company] = job.domain;
                }
            });
        }

        function getCompanyCounts(jobs) {
            const counts = {};
            jobs.forEach(job => {
                counts[job.company] = (counts[job.company] || 0) + 1;
            });
            return counts;
        }

        function buildFilterMenu(jobs) {
            const menu = document.getElementById('filter-menu');
            const counts = getCompanyCounts(jobs);
            const companies = Object.keys(counts).sort();

            // Initialize all companies as selected
            companies.forEach(c => selectedCompanies.add(c));

            let html = `<div class="filter-menu-inner">
                <label class="select-all">
                    <input type="checkbox" id="select-all" checked>
                    <span>All Companies</span>
                    <span class="filter-count">${jobs.length}</span>
                </label>
                <div class="filter-divider"></div>
                <div class="filter-grid">
            `;

            companies.forEach(company => {
                html += `
                    <label>
                        <input type="checkbox" value="${company}" checked class="company-checkbox">
                        <span>${company}</span>
                        <span class="filter-count">${counts[company]}</span>
                    </label>
                `;
            });

            html += `</div>`;

            html += `</div>`;
            menu.innerHTML = html;

            // Event listeners for checkboxes
            document.getElementById('select-all').addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.company-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = e.target.checked;
                    if (e.target.checked) {
                        selectedCompanies.add(cb.value);
                    } else {
                        selectedCompanies.delete(cb.value);
                    }
                });
                renderJobs();
            });

            document.querySelectorAll('.company-checkbox').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedCompanies.add(e.target.value);
                    } else {
                        selectedCompanies.delete(e.target.value);
                    }
                    updateSelectAll();
                    renderJobs();
                });
            });
        }

        function updateSelectAll() {
            const checkboxes = document.querySelectorAll('.company-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);
            const selectAll = document.getElementById('select-all');
            selectAll.checked = allChecked;
            selectAll.indeterminate = someChecked && !allChecked;
        }

        function renderJobs() {
            const jobList = document.getElementById('job-list');
            const jobCount = document.getElementById('job-count');

            const filteredJobs = allJobs.filter(job => selectedCompanies.has(job.company));

            jobCount.textContent = `${filteredJobs.length} position${filteredJobs.length !== 1 ? 's' : ''}`;

            if (filteredJobs.length === 0) {
                jobList.innerHTML = '<li class="loading">No jobs match your filter.</li>';
                return;
            }

            jobList.innerHTML = filteredJobs.map(job => {
                const logoUrl = getCompanyLogo(job.company);
                const companyUrl = job.domain ? `https://${job.domain}` : null;
                const logoHtml = logoUrl
                    ? (companyUrl
                        ? `<a href="${companyUrl}" target="_blank" rel="noopener" class="job-logo-link"><img src="${logoUrl}" alt="${job.company}" class="job-logo" onerror="this.style.display='none'"></a>`
                        : `<img src="${logoUrl}" alt="${job.company}" class="job-logo" onerror="this.style.display='none'">`)
                    : '';
                return `
                <li class="job-item${job.description ? ' has-description' : ''}">
                    ${logoHtml}
                    <div class="job-info">
                        <a href="${job.url}" class="job-title" target="_blank" rel="noopener">${job.title}</a>
                        <div class="job-company">${companyUrl ? `<a href="${companyUrl}" target="_blank" rel="noopener">${job.company}</a>` : job.company}</div>
                        <div class="job-location">${job.location || ''}</div>
                        <div class="job-scraped">Scraped: ${formatDate(job.scraped_at)}</div>
                    </div>
                    ${job.description ? `<div class="job-tooltip">${job.description}</div>` : ''}
                </li>
            `}).join('');
        }

        async function loadJobs() {
            const jobList = document.getElementById('job-list');
            const jobCount = document.getElementById('job-count');

            try {
                const response = await fetch('jobs.json');
                if (!response.ok) throw new Error('Failed to load jobs');

                allJobs = await response.json();

                if (allJobs.length === 0) {
                    jobList.innerHTML = '<li class="loading">No jobs found.</li>';
                    return;
                }

                buildDomainMap(allJobs);
                buildFilterMenu(allJobs);
                renderJobs();

            } catch (error) {
                jobList.innerHTML = `<li class="error">Error loading jobs: ${error.message}</li>`;
            }
        }

        async function loadArchivedCount() {
            try {
                const response = await fetch('archived_jobs.json');
                if (!response.ok) return;
                const jobs = await response.json();
                if (jobs.length > 0) {
                    document.getElementById('bin-count').textContent = jobs.length;
                    document.getElementById('bin-link').style.display = 'flex';
                }
            } catch (e) {
                // Archive file doesn't exist yet, that's fine
            }
        }

        // Filter menu hover/click behavior
        const filterContainer = document.getElementById('filter-container');
        const filterBtn = document.getElementById('filter-btn');
        const filterMenu = document.getElementById('filter-menu');

        filterBtn.addEventListener('click', () => {
            menuPinned = !menuPinned;
            filterBtn.classList.toggle('active', menuPinned);
            if (menuPinned) {
                filterMenu.classList.add('show');
            } else {
                filterMenu.classList.remove('show');
            }
        });

        filterContainer.addEventListener('mouseenter', () => {
            if (!menuPinned) {
                filterMenu.classList.add('show');
            }
        });

        filterContainer.addEventListener('mouseleave', () => {
            if (!menuPinned) {
                filterMenu.classList.remove('show');
            }
        });

        loadJobs();
        loadArchivedCount();

        // Subscribe functionality
        const WORKER_URL = 'https://qualityjobs-subscriptions.dpenko.workers.dev';

        const subscribeBtn = document.getElementById('subscribe-btn');
        const subscribeModal = document.getElementById('subscribe-modal');
        const subscribeForm = document.getElementById('subscribe-form');
        const subscribeEmail = document.getElementById('subscribe-email');
        const cancelSubscribe = document.getElementById('cancel-subscribe');
        const submitSubscribe = document.getElementById('submit-subscribe');
        const modalMessage = document.getElementById('modal-message');

        function showModal() {
            subscribeModal.classList.add('show');
            subscribeEmail.focus();
        }

        function hideModal() {
            subscribeModal.classList.remove('show');
            subscribeForm.reset();
            modalMessage.className = 'modal-message';
            modalMessage.textContent = '';
        }

        function showMessage(text, type) {
            modalMessage.textContent = text;
            modalMessage.className = `modal-message ${type}`;
        }

        subscribeBtn.addEventListener('click', showModal);
        cancelSubscribe.addEventListener('click', hideModal);

        subscribeModal.addEventListener('click', (e) => {
            if (e.target === subscribeModal) hideModal();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') hideModal();
        });

        subscribeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = subscribeEmail.value.trim();

            if (!email) return;

            submitSubscribe.disabled = true;
            submitSubscribe.textContent = 'Subscribing...';

            try {
                const response = await fetch(`${WORKER_URL}/subscribe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email }),
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(data.message || 'Subscribed successfully!', 'success');
                    subscribeForm.reset();
                    setTimeout(hideModal, 2000);
                } else {
                    showMessage(data.error || 'Failed to subscribe', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            } finally {
                submitSubscribe.disabled = false;
                submitSubscribe.textContent = 'Subscribe';
            }
        });
    </script>
</body>
</html>
